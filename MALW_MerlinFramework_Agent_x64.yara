import "pe"

rule Merlin_x64_agent_is_DLLPE
{
	condition:
		pe.is_pe and pe.characteristics & pe.DLL
}

rule Merlin_Agent_x86_x64_Exports
{
    condition:
        pe.exports("Run") and
        pe.exports("DllInstall") and
        pe.exports("DllRegisterServer") and
        pe.exports("DllUnregisterServer") and
        pe.exports("Merlin") and
        pe.exports("VoidFunc") and
        pe.exports("_cgo_dummy_export")
}

rule Merlin_Agent_Has_Sections
{
	condition:
		pe.number_of_sections >= 18
}

rule Merlin_x64_agent_Merlin_Export
{
	meta: 
		description = "Detects Merlin Framework x64 Agent"
		info = ""
		author = "Michael Andersen"
		reference = "https://www.virustotal.com/gui/file/0678d021eea3bcf377bebc76c4f91b74c29db1e48e70c371423c9944a1ec25d4/detection"
		date = "2022-01-27"
		hash0 = "0678d021eea3bcf377bebc76c4f91b74c29db1e48e70c371423c9944a1ec25d4"

	strings:
		$STR1 = { 41 54 53 4? 83 ec ?? 4? 89 cb e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 41 b8 ?? ?? ?? ?? 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 4? 89 c1 4? 89 5c ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 5b 41 5c c3  }

	condition:
		$STR1
}

rule Merlin_x64_agent_Run_Export
{
	strings:
		$STR2 = { 41 54 4? 83 ec ?? e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 45 31 c0 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 0f b6 05 ?? ?? ?? ?? 4? 89 e1 88 44 ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 41 5c c3  }

	condition:
		$STR2
}

rule Merlin_x64_agent_VoidFunc_Export
{
	strings:
		$STR3 = { 41 54 4? 83 ec ?? e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 45 31 c0 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 0f b6 05 ?? ?? ?? ?? 4? 89 e1 88 44 ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 41 5c c3  }

	condition:
		$STR3
}

rule Merlin_x64_agent_DllUnregisterServer_Export
{
	strings:
		$STR4 = { 41 54 4? 83 ec ?? e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 45 31 c0 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 0f b6 05 ?? ?? ?? ?? 4? 89 e1 88 44 ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 41 5c c3  }

	condition:
		$STR4
}

rule Merlin_x64_agent_DllRegisterServer_Export
{
	strings:
		$STR5 = { 41 54 4? 83 ec ?? e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 45 31 c0 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 0f b6 05 ?? ?? ?? ?? 4? 89 e1 88 44 ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 41 5c c3  }

	condition:
		$STR5
}


rule Merlin_x64_agent_DllInstall_Export
{
	strings:
		$STR6 = { 41 54 4? 83 ec ?? e8 ?? ?? ?? ?? 4? 8d ?? ?? ?? 45 31 c0 4? 8d 0d ?? ?? ?? ?? 4? 89 c4 0f b6 05 ?? ?? ?? ?? 4? 89 e1 88 44 ?? ?? e8 ?? ?? ?? ?? 4? 89 e1 e8 ?? ?? ?? ?? 90 4? 83 c4 ?? 41 5c c3  }

	condition:
		$STR6
}
